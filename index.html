<!DOCTYPE html>
<html>
<head>
    <title>Eggit Sunny</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- IMPORT RETRO FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        body { 
            background: #111; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            color: white;
            font-family: 'VT323', monospace;
            overflow: hidden;
        }
        canvas { 
            background: #051105; 
            border: 4px solid #333; 
            max-width: 100%; 
            max-height: 95vh; 
            touch-action: none; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            transition: background-color 1s ease;
            image-rendering: pixelated; 
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="1200"></canvas>

    <!-- Load the designer file -->
    <script src="levels.js"></script>
    
    <!-- Game Engine -->
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const worldHeight = 5000; 

        // Global State
        let currentLevel = 1;
        let keys = {};
        let gameWon = false;
        let isTouching = false;

        // Initialize Level
        // Uses window.levelLibrary from levels.js
        let currentLevelData = window.levelLibrary[currentLevel] || window.levelLibrary[1];
        let platforms = currentLevelData.platforms;
        let currentTheme = window.themeLibrary[currentLevelData.theme || "matrix"];

        let egg = {
            x: 400, y: 4900, radius: 15, dy: 0, jumpPower: -7.5, moveSpeed: 6 
        };

        const gravity = 0.15; 
        const bounce = -9.0;  
        let cameraY = worldHeight - canvas.height;

        canvas.style.background = currentTheme.bg;

        // --- PARTICLE SYSTEM ---
        let backgroundParticles = [];
        const digitalSymbols = ["01", "00", "{ }", "=>", "f()", "∑", "Ω", "∆", "∫", "<?>"];
        
        function initParticles(type) {
            backgroundParticles = [];
            const count = 40;
            for (let i = 0; i < count; i++) {
                if (type === "digital") {
                    backgroundParticles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * worldHeight,
                        text: digitalSymbols[Math.floor(Math.random() * digitalSymbols.length)],
                        speed: 0.05 + Math.random() * 0.1,
                        opacity: 0.1 + Math.random() * 0.2,
                        type: "text"
                    });
                } else if (type === "ash") {
                    // Ash falls DOWN slowly
                    backgroundParticles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * worldHeight,
                        size: 1 + Math.random() * 3,
                        speed: 0.5 + Math.random() * 1.0, 
                        opacity: 0.2 + Math.random() * 0.3,
                        type: "ash"
                    });
                }
            }
        }
        
        initParticles(currentTheme.particle);

        // --- LEVEL SWITCHING ---
        function startNextLevel() {
            currentLevel++;
            
            if (window.levelLibrary[currentLevel]) {
                currentLevelData = window.levelLibrary[currentLevel];
            } else {
                currentLevel = 1; 
                currentLevelData = window.levelLibrary[1];
            }

            platforms = currentLevelData.platforms;
            currentTheme = window.themeLibrary[currentLevelData.theme];
            canvas.style.background = currentTheme.bg; 
            
            initParticles(currentTheme.particle);

            gameWon = false;
            egg.y = 4900;
            egg.x = 400;
            egg.dy = 0;
            cameraY = worldHeight - canvas.height;
        }

        // --- INPUTS ---
        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (e.code === 'KeyR' && gameWon) startNextLevel();
            if (e.code === 'KeyN') startNextLevel(); // Cheat key
        });

        window.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isTouching = true;
            if (gameWon) startNextLevel();
            handleTouch(e);
        }, {passive: false});

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            handleTouch(e);
        }, {passive: false});

        canvas.addEventListener('touchend', () => isTouching = false);

        function handleTouch(e) {
            let rect = canvas.getBoundingClientRect();
            let touchX = e.touches[0].clientX - rect.left;
            let scaleX = canvas.width / rect.width;
            egg.x = touchX * scaleX;
        }

        // RENDERER LOGIC
        function drawPlatform(plat) {
            let style = currentTheme.renderStyle; 
            
            ctx.save();
            
            if (style === "neon") {
                // --- DIGITAL/NEON STYLE ---
                ctx.shadowBlur = plat.isGoal ? 25 : 10;
                let pColor = plat.isGoal ? "gold" : currentTheme.platformGlow;
                let pBody = plat.isGoal ? "gold" : currentTheme.platformBody;

                ctx.shadowColor = pColor;
                ctx.fillStyle = pBody;
                ctx.strokeStyle = pColor;
                ctx.lineWidth = 2;
                
                ctx.fillRect(plat.x, plat.y - cameraY, plat.width, plat.height);
                ctx.strokeRect(plat.x, plat.y - cameraY, plat.width, plat.height);
                
                ctx.shadowBlur = 0;
                ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
                ctx.strokeRect(plat.x + 6, (plat.y - cameraY) + 4, plat.width - 12, 2);
            } 
            else if (style === "industrial") {
                // --- INDUSTRIAL/FOUNDRY STYLE ---
                ctx.fillStyle = currentTheme.platformBody;
                ctx.fillRect(plat.x, plat.y - cameraY, plat.width, plat.height);
                
                // Border
                ctx.strokeStyle = "#000";
                ctx.lineWidth = 2;
                ctx.strokeRect(plat.x, plat.y - cameraY, plat.width, plat.height);

                // Texture: Stripes
                ctx.save();
                ctx.beginPath();
                ctx.rect(plat.x, plat.y - cameraY, plat.width, plat.height);
                ctx.clip(); 
                
                ctx.strokeStyle = "rgba(0, 0, 0, 0.3)";
                ctx.lineWidth = 4;
                if (!plat.isGoal) {
                    for(let k = 0; k < plat.width + plat.height; k+=20) {
                        ctx.beginPath();
                        ctx.moveTo(plat.x + k, plat.y - cameraY - 10);
                        ctx.lineTo(plat.x + k - 20, plat.y - cameraY + plat.height + 10);
                        ctx.stroke();
                    }
                }
                ctx.restore();

                // Rivets
                ctx.fillStyle = "#555";
                ctx.beginPath();
                ctx.arc(plat.x + 5, plat.y - cameraY + 5, 2, 0, Math.PI*2); // Top L
                ctx.arc(plat.x + plat.width - 5, plat.y - cameraY + 5, 2, 0, Math.PI*2); // Top R
                ctx.arc(plat.x + 5, plat.y - cameraY + plat.height - 5, 2, 0, Math.PI*2); // Bot L
                ctx.arc(plat.x + plat.width - 5, plat.y - cameraY + plat.height - 5, 2, 0, Math.PI*2); // Bot R
                ctx.fill();

                if (plat.isGoal) {
                    ctx.fillStyle = "gold";
                    ctx.fillRect(plat.x, plat.y - cameraY, plat.width, plat.height);
                    ctx.strokeRect(plat.x, plat.y - cameraY, plat.width, plat.height);
                }
            }

            ctx.restore();
        }

        function drawEgg() {
            ctx.save();
            ctx.translate(egg.x, egg.y - cameraY);
            
            ctx.beginPath();
            ctx.moveTo(0, -egg.radius * 1.2);
            ctx.bezierCurveTo(egg.radius * 0.8, -egg.radius * 1.2, egg.radius * 1.1, egg.radius * 1.0, 0, egg.radius * 1.1);
            ctx.bezierCurveTo(-egg.radius * 1.1, egg.radius * 1.0, -egg.radius * 0.8, -egg.radius * 1.2, 0, -egg.radius * 1.2);
            ctx.fillStyle = "#FFD700";
            ctx.fill();
            
            ctx.beginPath();
            ctx.ellipse(-4, -6, 3, 5, Math.PI / 4, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            ctx.fill();
            ctx.restore();
        }

        function drawHUD() {
            ctx.save();
            ctx.font = "20px 'Press Start 2P', monospace"; 
            ctx.fillStyle = currentTheme.uiColor;
            ctx.textAlign = "left";
            ctx.shadowBlur = 0; 
            
            // Level Counter
            ctx.fillText(`LEVEL ${currentLevel}`, 20, 40);
            
            // Zone Name
            ctx.font = "16px 'VT323', monospace";
            ctx.fillText(`ZONE: ${currentTheme.zoneName}`, 20, 65);
            ctx.restore();
        }

        function update() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. Background Layers
            ctx.save();
            
            // --- DRAW BACKGROUND PATTERN ---
            if (currentTheme.bgType === "grid") {
                // TYPE A: The Digital Grid
                ctx.strokeStyle = currentTheme.grid; 
                ctx.lineWidth = 1;
                let gridOffset = (-cameraY * 0.4) % 80;
                for (let y = gridOffset; y <= canvas.height; y += 80) {
                    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
                }
                for (let x = 0; x <= canvas.width; x += 80) {
                    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
                }
            } else if (currentTheme.bgType === "industrial") {
                // TYPE B: The Plated Wall (No Grid)
                ctx.strokeStyle = currentTheme.grid; // Dark rusty lines
                ctx.lineWidth = 2;
                let plateHeight = 200;
                let plateOffset = (-cameraY * 0.4) % plateHeight;
                
                // Draw horizontal plate seams only
                for (let y = plateOffset; y <= canvas.height; y += plateHeight) {
                    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
                    // Add bolts along the seam
                    ctx.fillStyle = "#111";
                    for (let x = 20; x < canvas.width; x+=100) {
                        ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI*2); ctx.fill();
                    }
                }
            }

            // Particles
            backgroundParticles.forEach(p => {
                if (p.type === "text") {
                    let drawY = (p.y - cameraY * 0.6) % 1500;
                    if (drawY < 0) drawY += 1500;
                    if (drawY < canvas.height) {
                        ctx.font = "12px monospace";
                        ctx.fillStyle = `rgba(${currentTheme.runeColor}, ${p.opacity})`;
                        ctx.fillText(p.text, p.x, drawY);
                    }
                } else if (p.type === "ash") {
                    // Ash falls DOWN slowly
                    let drawY = (p.y + (Date.now() * 0.05 * p.speed) - cameraY * 0.2) % 1500;
                    
                    // Wrap logic
                    while (drawY < 0) drawY += 1500;
                    while (drawY > 1500) drawY -= 1500;

                    if (drawY < canvas.height) {
                        ctx.beginPath();
                        ctx.arc(p.x, drawY, p.size, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(${currentTheme.runeColor}, ${p.opacity})`;
                        ctx.fill();
                    }
                }
            });
            ctx.restore();

            // 2. Physics
            if (!gameWon) {
                if (!isTouching) {
                    if (keys['ArrowLeft']) egg.x -= egg.moveSpeed;
                    if (keys['ArrowRight']) egg.x += egg.moveSpeed;
                }
                egg.dy += gravity;
                egg.y += egg.dy;
            }

            if (egg.x < egg.radius) egg.x = egg.radius;
            if (egg.x > canvas.width - egg.radius) egg.x = canvas.width - egg.radius;

            if (egg.y + egg.radius > worldHeight) {
                egg.y = worldHeight - egg.radius;
                egg.dy = bounce;
            }

            platforms.forEach(plat => {
                if (egg.dy > 0 && egg.y + egg.radius > plat.y && egg.y + egg.radius < plat.y + plat.height && egg.x > plat.x && egg.x < plat.x + plat.width) {
                    egg.y = plat.y - egg.radius;
                    egg.dy = bounce;
                    if (plat.isGoal) gameWon = true;
                }
            });

            let targetY = egg.y - (canvas.height * 0.7);
            cameraY += (targetY - cameraY) * 0.08;
            if (cameraY > worldHeight - canvas.height) cameraY = worldHeight - canvas.height;
            if (cameraY < -200) cameraY = -200;

            // 3. Draw Game Objects
            platforms.forEach(plat => {
                drawPlatform(plat);
            });

            drawEgg();
            drawHUD(); 

            // 4. Success UI
            if (gameWon) {
                ctx.fillStyle = "rgba(0, 0, 0, 0.85)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                let boxW = Math.min(canvas.width * 0.85, 500);
                let boxH = 280;
                
                ctx.save();
                ctx.shadowBlur = 0; 
                ctx.shadowColor = "transparent";
                ctx.fillStyle = "#222"; 
                ctx.strokeStyle = currentTheme.uiColor; 
                ctx.lineWidth = 4;
                
                ctx.fillRect(canvas.width/2 - boxW/2, canvas.height/2 - boxH/2, boxW, boxH);
                ctx.strokeRect(canvas.width/2 - boxW/2, canvas.height/2 - boxH/2, boxW, boxH);

                ctx.fillStyle = currentTheme.uiColor; 
                ctx.textAlign = "center";
                
                ctx.font = "24px 'Press Start 2P', monospace"; 
                ctx.fillText(`LEVEL ${currentLevel} CLEAR`, canvas.width/2, canvas.height/2 - 30);
                
                ctx.font = "24px 'VT323', monospace";
                ctx.fillStyle = "#FFFFFF";
                ctx.fillText("Well done little egg...", canvas.width/2, canvas.height/2 + 20);
                
                ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
                ctx.fillText("Tap or Press 'R' for Next Stage", canvas.width/2, canvas.height/2 + 80);
                ctx.restore();
            }

            requestAnimationFrame(update);
        }

        update();
    </script>
</body>
</html>